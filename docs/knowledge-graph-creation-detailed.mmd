%%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#22d3ee', 'primaryTextColor': '#f1f5f9', 'primaryBorderColor': '#0e7490', 'lineColor': '#94a3b8', 'secondaryColor': '#1e293b', 'tertiaryColor': '#334155', 'fontSize': '14px'}}}%%

flowchart TB
    %% ===========================================
    %% KNOWLEDGE SOURCES
    %% ===========================================
    subgraph SourcesLayer["üì• KNOWLEDGE SOURCES"]
        direction TB

        subgraph ClaudeLogs["ü§ñ Claude Code Logs (Automatic)"]
            LOG_PATH["~/.claude/projects/"]
            LOG_FILES["*.jsonl files"]
            LOG_DESC["Contains: AI conversations<br/>from Claude Code CLI sessions"]
        end

        subgraph Interview["üë§ AI Interview (Interactive)"]
            INT_UI["Web UI: /capture"]
            INT_WS["WebSocket connection"]
            INT_DESC["User describes decisions<br/>through guided conversation"]
        end

        subgraph Manual["‚úèÔ∏è Manual Entry (Direct)"]
            MAN_FORM["Decision Form"]
            MAN_DESC["User fills in all fields<br/>directly without AI assistance"]
        end
    end

    %% ===========================================
    %% INGESTION PIPELINES
    %% ===========================================
    subgraph IngestionLayer["‚öôÔ∏è INGESTION PIPELINES"]
        direction TB

        subgraph LogPipeline["üìÇ Log Parsing Pipeline<br/><i>services/parser.py</i>"]
            LP1["1. Glob: **/*.jsonl"]
            LP2["2. Skip subagents/"]
            LP3["3. Compute SHA-256 hash"]
            LP4["4. Check if processed"]
            LP5["5. Parse JSON lines"]
            LP6["6. Extract message blocks"]
            LP7["7. Build Conversation object"]

            LP1 --> LP2 --> LP3 --> LP4
            LP4 -->|New file| LP5 --> LP6 --> LP7
            LP4 -->|Already processed| LP_SKIP["Skip file"]
        end

        subgraph InterviewPipeline["üí¨ Interview Pipeline<br/><i>agents/interview.py</i>"]
            IP1["1. Create session (POST /sessions)"]
            IP2["2. AI asks: What triggered?"]
            IP3["3. User responds"]
            IP4["4. AI asks: What context?"]
            IP5["5. Continue 5-stage flow"]
            IP6["6. AI synthesizes decision"]
            IP7["7. Complete session"]

            IP1 --> IP2 --> IP3 --> IP4 --> IP5 --> IP6 --> IP7
        end
    end

    %% ===========================================
    %% AI EXTRACTION
    %% ===========================================
    subgraph ExtractionLayer["üß† AI EXTRACTION ENGINE<br/><i>services/extractor.py</i>"]
        direction TB

        subgraph LLMConfig["LLM Configuration"]
            LLM_MODEL["NVIDIA Llama 3.3 Nemotron Super 49B"]
            LLM_API["API: integrate.api.nvidia.com/v1"]
            LLM_TEMP["Temperature: 0.3 (focused)"]
        end

        subgraph DecisionExtraction["Decision Extraction"]
            DE1["Input: Conversation text"]
            DE2["Prompt: 'Extract technical decisions...'"]
            DE3["Output: JSON array"]
            DE4["Parse: trigger, context, options,<br/>decision, rationale, confidence"]

            DE1 --> DE2 --> DE3 --> DE4
        end

        subgraph EntityExtraction["Entity Extraction"]
            EE1["Input: Decision text"]
            EE2["Prompt: 'Extract technical entities...'"]
            EE3["Categories:<br/>concept | system | technology<br/>pattern | person"]
            EE4["Output: [{name, type}]"]

            EE1 --> EE2 --> EE3 --> EE4
        end

        subgraph RelationshipExtraction["Relationship Extraction"]
            RE1["Input: List of entities"]
            RE2["Prompt: 'Identify relationships...'"]
            RE3["Types:<br/>IS_A | PART_OF<br/>RELATED_TO | DEPENDS_ON"]
            RE4["Output: [{from, to, type, confidence}]"]

            RE1 --> RE2 --> RE3 --> RE4
        end
    end

    %% ===========================================
    %% EMBEDDING GENERATION
    %% ===========================================
    subgraph EmbeddingLayer["üîÆ EMBEDDING GENERATION<br/><i>services/embeddings.py</i>"]
        direction TB

        subgraph EmbModel["Embedding Model"]
            EMB_NAME["NVIDIA NV-EmbedQA 1B v2"]
            EMB_API["API: integrate.api.nvidia.com/v1"]
            EMB_DIM["Dimensions: 2048"]
        end

        subgraph DecisionEmbed["Decision Embedding"]
            DEM1["Combine fields:"]
            DEM2["'Decision Trigger: {trigger}<br/>Context: {context}<br/>Options: {options}<br/>Decision: {decision}<br/>Rationale: {rationale}'"]
            DEM3["input_type: 'passage'"]
            DEM4["Output: float[2048]"]

            DEM1 --> DEM2 --> DEM3 --> DEM4
        end

        subgraph EntityEmbed["Entity Embedding"]
            EEM1["Format: '{type}: {name}'"]
            EEM2["input_type: 'passage'"]
            EEM3["Output: float[2048]"]

            EEM1 --> EEM2 --> EEM3
        end
    end

    %% ===========================================
    %% GRAPH STORAGE
    %% ===========================================
    subgraph StorageLayer["üîó NEO4J GRAPH STORAGE<br/><i>db/neo4j.py</i>"]
        direction TB

        subgraph Indexes["Indexes & Constraints"]
            IDX1["UNIQUE: DecisionTrace.id"]
            IDX2["UNIQUE: Entity.id"]
            IDX3["INDEX: Entity.name"]
            IDX4["VECTOR INDEX: decision_embedding"]
            IDX5["VECTOR INDEX: entity_embedding"]
            IDX6["FULLTEXT INDEX: decision_fulltext"]
        end

        subgraph NodeCreation["Node Creation"]
            NC_DEC["CREATE (:DecisionTrace {<br/>  id, trigger, context, options,<br/>  decision, rationale, confidence,<br/>  source, embedding, created_at<br/>})"]
            NC_ENT["MERGE (:Entity {name})<br/>ON CREATE SET id, type, embedding"]
        end

        subgraph RelCreation["Relationship Creation"]
            RC_INV["(d:DecisionTrace)-[:INVOLVES {weight}]->(e:Entity)"]
            RC_SIM["(d1)-[:SIMILAR_TO {score}]->(d2)"]
            RC_INF["(d_new)-[:INFLUENCED_BY {shared}]->(d_old)"]
            RC_ISA["(e1)-[:IS_A {confidence}]->(e2)"]
            RC_PART["(e1)-[:PART_OF]->(e2)"]
            RC_REL["(e1)-[:RELATED_TO]->(e2)"]
            RC_DEP["(e1)-[:DEPENDS_ON]->(e2)"]
        end
    end

    %% ===========================================
    %% AUTOMATIC ENRICHMENT
    %% ===========================================
    subgraph EnrichmentLayer["‚ú® AUTOMATIC ENRICHMENT"]
        direction TB

        subgraph SimilarityDetection["Similarity Detection"]
            SIM1["Fetch all decision embeddings"]
            SIM2["For each pair: cosine_similarity(a, b)"]
            SIM3["If score > 0.75: create SIMILAR_TO"]
            SIM4["Edge stores: score = similarity"]

            SIM1 --> SIM2 --> SIM3 --> SIM4
        end

        subgraph TemporalChains["Temporal Chain Detection"]
            TC1["Find decisions sharing ‚â•2 entities"]
            TC2["Compare created_at timestamps"]
            TC3["If newer decision influenced by older:"]
            TC4["Create INFLUENCED_BY edge"]

            TC1 --> TC2 --> TC3 --> TC4
        end
    end

    %% ===========================================
    %% CONNECTIONS
    %% ===========================================

    %% Source to Ingestion
    ClaudeLogs -->|"POST /api/ingest/trigger"| LogPipeline
    Interview -->|"WebSocket /api/capture/ws"| InterviewPipeline
    Manual -->|"POST /api/decisions"| DecisionExtraction

    %% Ingestion to Extraction
    LP7 -->|"Conversation object"| DecisionExtraction
    IP7 -->|"Synthesized decision"| DecisionExtraction

    %% Extraction flow
    DE4 --> EntityExtraction
    EE4 --> RelationshipExtraction

    %% Extraction to Embedding
    DE4 -->|"Decision fields"| DecisionEmbed
    EE4 -->|"Entity name + type"| EntityEmbed

    %% Embedding to Storage
    DEM4 --> NodeCreation
    EEM3 --> NodeCreation
    RE4 --> RelCreation

    %% Storage to Enrichment
    NodeCreation --> SimilarityDetection
    NodeCreation --> TemporalChains

    %% Enrichment back to Storage
    SIM4 --> RC_SIM
    TC4 --> RC_INF

    %% ===========================================
    %% STYLING
    %% ===========================================
    classDef sourceStyle fill:#7c3aed,stroke:#a78bfa,stroke-width:2px,color:#f1f5f9
    classDef ingestStyle fill:#0891b2,stroke:#22d3ee,stroke-width:2px,color:#f1f5f9
    classDef extractStyle fill:#d97706,stroke:#fbbf24,stroke-width:2px,color:#f1f5f9
    classDef embedStyle fill:#8b5cf6,stroke:#a78bfa,stroke-width:2px,color:#f1f5f9
    classDef storageStyle fill:#2563eb,stroke:#60a5fa,stroke-width:2px,color:#f1f5f9
    classDef enrichStyle fill:#ec4899,stroke:#f472b6,stroke-width:2px,color:#f1f5f9

    class ClaudeLogs,Interview,Manual sourceStyle
    class LogPipeline,InterviewPipeline ingestStyle
    class LLMConfig,DecisionExtraction,EntityExtraction,RelationshipExtraction extractStyle
    class EmbModel,DecisionEmbed,EntityEmbed embedStyle
    class Indexes,NodeCreation,RelCreation storageStyle
    class SimilarityDetection,TemporalChains enrichStyle
